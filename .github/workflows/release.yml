name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  YUNET_ORIGINAL_SHA256: 8f2383e4dd3cfbb4553ea8718107fc0423210dc964f9f4280604804ed2552fa4
  YUNET_640_SHA256: d2c5a887db77802389261b13d2b9f5e1171b9d5787cb315d0add225812ff4d96

jobs:
  windows-release:
    name: Windows Release Artifacts
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install onnxsim
        run: pip install onnxsim==0.4.36

      - name: Download and process models
        shell: bash
        run: |
          mkdir -p models
          curl -L -o models/face_detection_yunet_2023mar.onnx https://github.com/opencv/opencv_zoo/raw/main/models/face_detection_yunet/face_detection_yunet_2023mar.onnx
          onnxsim models/face_detection_yunet_2023mar.onnx models/face_detection_yunet_2023mar_640.onnx --path-to-input-shape="1,3,640,640" || onnxsim models/face_detection_yunet_2023mar.onnx models/face_detection_yunet_2023mar_640.onnx --input-shape="1,3,640,640"

      - name: Retry model generation (simpler syntax)
        if: failure()
        shell: bash
        run: |
          onnxsim models/face_detection_yunet_2023mar.onnx models/face_detection_yunet_2023mar_640.onnx 1,3,640,640

      - name: Verify model checksums
        shell: bash
        run: |
          python - <<'PY'
          import hashlib
          import os
          import pathlib
          import sys

          expected = {
              "models/face_detection_yunet_2023mar.onnx": os.environ["YUNET_ORIGINAL_SHA256"],
              "models/face_detection_yunet_2023mar_640.onnx": os.environ["YUNET_640_SHA256"],
          }

          def sha256(path: pathlib.Path) -> str:
              h = hashlib.sha256()
              with path.open("rb") as f:
                  for chunk in iter(lambda: f.read(1024 * 1024), b""):
                      h.update(chunk)
              return h.hexdigest()

          failed = False
          for rel_path, expected_hash in expected.items():
              path = pathlib.Path(rel_path)
              if not path.exists():
                  print(f"Missing model file: {rel_path}", file=sys.stderr)
                  failed = True
                  continue
              actual_hash = sha256(path)
              if actual_hash != expected_hash:
                  print(
                      f"Checksum mismatch for {rel_path}: expected {expected_hash}, got {actual_hash}",
                      file=sys.stderr,
                  )
                  failed = True
              else:
                  print(f"Verified {rel_path}: {actual_hash}")

          if failed:
              sys.exit(1)
          PY

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: swatinem/rust-cache@v2

      - name: Build release binaries
        run: cargo build --release -p yunet-cli -p yunet-gui

      - name: Package artifacts
        shell: pwsh
        run: |
          $DistName = "iron-cropper-windows-x86_64"
          $DistDir = "dist/$DistName"
          New-Item -ItemType Directory -Force -Path $DistDir | Out-Null

          Copy-Item target/release/yunet-cli.exe "$DistDir/yunet-cli.exe"
          Copy-Item target/release/yunet-gui.exe "$DistDir/yunet-gui.exe"
          Copy-Item models/face_detection_yunet_2023mar_640.onnx "$DistDir/face_detection_yunet_2023mar_640.onnx"
          if (Test-Path README.md) {
            Copy-Item README.md "$DistDir/README.md"
          }
          if (Test-Path LICENSE) {
            Copy-Item LICENSE "$DistDir/LICENSE"
          }
          if (Test-Path LICENSE-APACHE) {
            Copy-Item LICENSE-APACHE "$DistDir/LICENSE-APACHE"
          }
          if (Test-Path LICENSE-MIT) {
            Copy-Item LICENSE-MIT "$DistDir/LICENSE-MIT"
          }

          Compress-Archive -Path "$DistDir/*" -DestinationPath "dist/$DistName.zip" -Force

      - name: Generate checksums
        shell: bash
        run: |
          cd dist
          sha256sum iron-cropper-windows-x86_64.zip > SHA256SUMS.txt

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release-artifacts
          path: |
            dist/iron-cropper-windows-x86_64.zip
            dist/SHA256SUMS.txt

      - name: Publish GitHub release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/iron-cropper-windows-x86_64.zip
            dist/SHA256SUMS.txt
